---
title: "Transformación de Datos"
author: "Carlos Orts"
date: "2025-08-20"
output: html_document
---

# ==============================
# 1. Librerias
# ==============================
```{r}
if(!require(readr)){install.packages('readr')
  library(readr)
}

if(!require(haven)){install.packages('haven')
  library(haven)
}

if(!require(dplyr)){install.packages('dplyr')
  library(dplyr)
}

if(!require(tidyr)){install.packages('tidyr')
  library(tidyr)
}

if(!require(countrycode)){install.packages('countrycode')
  library(countrycode)
}
```
# ==============================
# 2. Cargar los datos
# ==============================
```{r}
# CSV con el % de trabajadores autónomos por país
dat_self_employed <- read.csv("self_employed_percent_of_employment.csv")

# CSV con el gdp por país
dat_gdp <- read.csv("gdp_pcap.csv")
```

# ======================================
# 3. Transformación de los datos a formato "tidy"
# ======================================

## 3.1 Transformación del Data frame que contiene la info de los trabajadores autónomos 
```{r}

dat_self <- dat_self_employed %>%
  
  # Pasar de formato ancho (X1991, X1992, ...) a formato largo
  pivot_longer(
    cols = starts_with("X"),          # Selecciona todas las columnas que empiezan con "X"
    names_to = "year",                 # Crea nueva columna "year" con los nombres de las columnas
    values_to = "self_employed_perc"   # Crea nueva columna con los valores numéricos
  ) %>%
  
  # Limpiar columna "year"
  mutate(year = as.numeric(gsub("X", "", year)))   # Quita la "X" y convierte a número

print(dat_self)
```

## 3.2 Transformación del Data frame que contiene la info del GDP por país
```{r}
# Eliminar un rango de columnas, debido a que solo disponemos información del 1991 hasta el 2019 del porcentaje de trabajadores autónomos
 dat_gdp <- dat_gdp %>%
  select(-any_of(c(paste0("X", 1800:1990),
                   paste0("X", 2020:2100))))


dat_gdp_tidy <- dat_gdp %>%
  
  # Pasar de formato ancho (X1991, X1992, ...) a formato largo
  pivot_longer(
    cols = starts_with("X"),          # Selecciona todas las columnas que empiezan con "X"
    names_to = "year",                 # Crea nueva columna "year" con los nombres de las columnas
    values_to = "gdp"   # Crea nueva columna con los valores numéricos
  ) %>%
  
  # Limpiar columna "year"
  mutate(year = as.numeric(gsub("X", "", year)))   # Quita la "X" y convierte a número

print(dat_gdp_tidy)
```
## 3.3 Unión de los datasets por país y año
```{r}
#Usamos inner join para mantener solo las filas donde ambos tienen datos cuando coincide país y año.
dat_base <- dat_self %>% 
    inner_join(dat_gdp_tidy, by = c("country", "year")) 

#Confirmamos que no hay ningún NA
sum(is.na(dat_base))

print(dat_base)
```
## 3.4 Remplazamos las abreviaturas y añadimos el continente con el paquete "countrycode"
```{r}
list(unique(dat_base$country))

# Corregimos los nombres para que no nos den errores con el paquete MAPS
recode_names <- c(
  # Diferencias de abreviaciones
  "UAE"        = "United Arab Emirates",
  
  # Variaciones en nombres de países
  "Cote d'Ivoire"      = "Ivory Coast",
  "Congo, Dem. Rep."   = "Democratic Republic of the Congo",
  "Congo, Rep."        = "Republic of Congo",
  "Kyrgyz Republic"    = "Kyrgyzstan",
  "Lao"                = "Laos",
  "St. Lucia"          = "Saint Lucia",
  "Slovak Republic"    = "Slovakia",
  "Eswatini"           = "Swaziland",
  "Trinidad and Tobago"= "Trinidad",   
  "St. Vincent and the Grenadines" = "Saint Vincent",
  "Palestine"          = "Palestine"  
)

# Reemplazar antes de usar countrycode
dat_base <- dat_base %>%
  mutate(
    country = recode(country, !!!recode_names, .default = country),
    continent = countrycode(country,
                            origin = "country.name",
                            destination = "continent")
  )
```

## 3.5 Transformamos la columna GDP a valores númericos
```{r}
dat_base <- dat_base %>%           
  mutate(                          # mutate() permite crear o modificar columnas existentes
    gdp = case_when(               # Reescribimos la columna "gdp" según distintas condiciones

      # --- CASO 1: valores terminados en "k" ---
      str_detect(gdp, "k$") ~      # str_detect() detecta si el valor termina en "k" ($ indica final del string)
        as.numeric(str_remove(gdp, "k")) * 1e3,  # str_remove() quita la "k", as.numeric() convierte a número y se multiplica por 1000

      # --- CASO 2: cualquier otro valor ---
      TRUE ~ as.numeric(gdp)       # 3c. Para todos los demás casos, convierte directamente a número
    )
  )
```



# 4. Crear archivo CSV
```{r}
write.csv(dat_base, "data_base.csv")
```
